# Implementation Plan: Task CRUD Operations with Authentication

**Branch**: `001-task-crud-auth` | **Date**: 2025-12-14 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-task-crud-auth/spec.md`

## Summary

Full-stack todo application with user authentication enabling task CRUD operations. Users can register, login, and manage their personal tasks (create, read, update, delete, toggle completion). Built with Next.js 16+ App Router frontend, FastAPI + SQLModel backend, PostgreSQL database, and Better Auth + JWT authentication. User data isolation is enforced at the service layer with mandatory user_id filtering on all queries.

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript 5.x (frontend)
**Primary Dependencies**: FastAPI, SQLModel, Pydantic v2, Alembic (backend); Next.js 16+, Better Auth, Tailwind CSS (frontend)
**Storage**: PostgreSQL 16 (Neon Serverless in production, Docker container in development)
**Testing**: pytest + httpx (backend); Jest + React Testing Library, Playwright (frontend)
**Target Platform**: Web application (Docker Compose for development, cloud deployment for production)
**Project Type**: Web application (frontend + backend)
**Performance Goals**: <2s page load, <500ms API response, 100 concurrent users
**Constraints**: User data isolation mandatory, JWT validation on all protected endpoints
**Scale/Scope**: MVP with 7 user stories, 2 entities, 9 API endpoints

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Spec-Driven Development | PASS | Complete spec at `specs/001-task-crud-auth/spec.md` with 7 user stories, 25 FRs, 10 SCs |
| II. Architectural Stewardship | PASS | Human-defined architecture in research.md, ADRs identified |
| III. Test-First, Always | READY | Test strategy defined, will implement Red-Green-Refactor |
| IV. Independent User Story Delivery | PASS | Each story independently testable per spec |
| V. Minimal Viable Change | READY | Focused scope, out-of-scope items defined |
| VI. Observability & Debuggability | PLANNED | Structured logging, OpenAPI docs |
| VII. API Contracts & Versioning | PASS | OpenAPI spec at `contracts/openapi.yaml` |
| VIII. Simplicity & YAGNI | PASS | No speculative features, minimal entities |
| IX. Human Intent Over Mechanical Compliance | PASS | Spec intent clear, clarifications resolved |

### Phase II Technology Compliance

| Requirement | Status | Implementation |
|-------------|--------|----------------|
| Next.js 16+ App Router | PLANNED | `frontend/app/` structure |
| Server Components default | PLANNED | Data fetching in Server Components |
| Client Components for interactivity | PLANNED | Forms with `'use client'` |
| TypeScript strict mode | PLANNED | `strict: true` in tsconfig |
| Tailwind CSS exclusively | PLANNED | No CSS modules or inline styles |
| FastAPI + SQLModel | PLANNED | `backend/src/` structure |
| Python 3.13+ with UV | PLANNED | `pyproject.toml` with UV |
| Pydantic v2 | PLANNED | Request/response validation |
| Alembic migrations | PLANNED | `backend/migrations/` |
| Better Auth + JWT | PLANNED | Shared secret authentication |
| User data isolation | CRITICAL | All queries filter by user_id |

## Project Structure

### Documentation (this feature)

```text
specs/001-task-crud-auth/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Technology decisions
├── data-model.md        # Entity definitions
├── quickstart.md        # Setup instructions
├── contracts/
│   ├── openapi.yaml     # OpenAPI specification
│   └── schemas.py       # Pydantic schemas reference
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks.md             # Task breakdown (generated by /sp.tasks)
```

### Source Code (repository root)

```text
frontend/
├── app/
│   ├── layout.tsx              # Root layout with providers
│   ├── page.tsx                # Landing/home page
│   ├── globals.css             # Tailwind imports
│   ├── (auth)/
│   │   ├── layout.tsx          # Auth pages layout
│   │   ├── login/
│   │   │   └── page.tsx        # Login page
│   │   └── register/
│   │       └── page.tsx        # Registration page
│   └── (dashboard)/
│       ├── layout.tsx          # Dashboard layout (protected)
│       └── tasks/
│           └── page.tsx        # Task list page
├── components/
│   ├── ui/
│   │   ├── button.tsx          # Reusable button
│   │   ├── input.tsx           # Form input
│   │   ├── card.tsx            # Card component
│   │   └── dialog.tsx          # Confirmation dialog
│   ├── auth/
│   │   ├── login-form.tsx      # Login form (Client Component)
│   │   └── register-form.tsx   # Registration form (Client Component)
│   └── tasks/
│       ├── task-list.tsx       # Task list container
│       ├── task-item.tsx       # Single task row (Client Component)
│       ├── task-form.tsx       # Create/edit form (Client Component)
│       └── empty-state.tsx     # No tasks message
├── lib/
│   ├── auth.ts                 # Better Auth configuration
│   ├── auth-client.ts          # Auth client instance
│   └── api.ts                  # API client for backend
├── types/
│   └── index.ts                # Shared TypeScript types
├── middleware.ts               # Auth middleware for protected routes
├── tailwind.config.ts
├── tsconfig.json
├── next.config.js
└── package.json

backend/
├── src/
│   ├── __init__.py
│   ├── main.py                 # FastAPI app entry point
│   ├── config.py               # Settings from environment
│   ├── database.py             # Database connection
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py             # User SQLModel
│   │   └── task.py             # Task SQLModel
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── user.py             # User Pydantic schemas
│   │   └── task.py             # Task Pydantic schemas
│   ├── api/
│   │   ├── __init__.py
│   │   ├── deps.py             # Dependencies (get_db, get_current_user)
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── router.py       # API v1 router
│   │   │   ├── auth.py         # Auth endpoints
│   │   │   └── tasks.py        # Task endpoints
│   └── services/
│       ├── __init__.py
│       ├── auth.py             # Auth business logic
│       └── tasks.py            # Task business logic (user_id filtering)
├── migrations/
│   ├── env.py                  # Alembic environment
│   ├── script.py.mako          # Migration template
│   └── versions/               # Migration files
├── tests/
│   ├── __init__.py
│   ├── conftest.py             # Fixtures
│   ├── test_auth.py            # Auth endpoint tests
│   ├── test_tasks.py           # Task endpoint tests
│   └── test_isolation.py       # User data isolation tests
├── pyproject.toml
├── requirements.txt
└── alembic.ini

# Root level
docker-compose.yml              # 3-service orchestration
.env.example                    # Environment template
.gitignore
README.md
```

**Structure Decision**: Web application structure with separate frontend and backend directories per Constitution Section III requirements. Monorepo with Docker Compose orchestration.

## Complexity Tracking

> No violations requiring justification. Architecture follows Constitution guidelines.

| Aspect | Choice | Rationale |
|--------|--------|-----------|
| Project count | 2 (frontend, backend) | Constitution mandates separate Next.js and FastAPI apps |
| ORM | SQLModel | Constitution requirement (not raw SQLAlchemy) |
| Auth | Better Auth + JWT | Constitution requirement |
| Database | PostgreSQL | Constitution requirement (Neon in production) |

## Architecture Decisions

### ADR Candidates Identified

1. **ADR-001: Better Auth + JWT Shared Secret Architecture**
   - Decision: Use Better Auth on frontend with JWT tokens validated by shared secret on backend
   - Impact: Authentication security model, token validation pattern
   - Status: Pending user approval for ADR creation

2. **ADR-002: User Data Isolation via Service Layer**
   - Decision: All database queries filter by user_id at the service layer
   - Impact: Security model, prevents data leakage between users
   - Status: Pending user approval for ADR creation

3. **ADR-003: Monorepo with Docker Compose Development**
   - Decision: Single repository with Docker Compose for local development
   - Impact: Development workflow, deployment pipeline
   - Status: Pending user approval for ADR creation

## Implementation Phases

### Phase 1: Infrastructure Setup
- Docker Compose configuration (3 services)
- Environment variable management
- Database setup and connection
- Project scaffolding (frontend + backend)

### Phase 2: Authentication (P1 Stories)
- User model and migration
- Registration endpoint and form
- Login endpoint and form
- JWT token handling
- Protected route middleware

### Phase 3: Task CRUD (P2-P3 Stories)
- Task model and migration
- List tasks endpoint and UI
- Create task endpoint and form
- Update task endpoint and form
- Delete task with confirmation
- Toggle completion

### Phase 4: Testing & Validation
- Unit tests (models, services)
- API contract tests
- Component tests
- User isolation security tests
- E2E user journey tests

## Security Implementation Checklist

- [ ] All task queries include `WHERE user_id = :current_user_id`
- [ ] JWT validation on all `/api/v1/tasks/*` endpoints
- [ ] 404 returned (not 403) when accessing another user's task
- [ ] Passwords hashed with bcrypt before storage
- [ ] Generic error message for invalid credentials
- [ ] httpOnly cookies for token storage
- [ ] CORS restricted to frontend origin
- [ ] Input validation on both client and server

## Generated Artifacts

| Artifact | Path | Description |
|----------|------|-------------|
| Research | `specs/001-task-crud-auth/research.md` | Technology decisions |
| Data Model | `specs/001-task-crud-auth/data-model.md` | Entity definitions |
| OpenAPI | `specs/001-task-crud-auth/contracts/openapi.yaml` | API specification |
| Schemas | `specs/001-task-crud-auth/contracts/schemas.py` | Pydantic schemas |
| Quickstart | `specs/001-task-crud-auth/quickstart.md` | Setup guide |

## Next Steps

1. **User approval**: Review plan and ADR suggestions
2. **Run `/sp.tasks`**: Generate detailed task breakdown
3. **Execute tasks**: Follow Red-Green-Refactor cycle
4. **Create ADRs**: Document approved architectural decisions

---

**Architectural decisions detected:**

- Better Auth + JWT shared secret authentication
- User data isolation via service layer filtering
- Monorepo with Docker Compose development

Document reasoning and tradeoffs? Run `/sp.adr <decision-title>` for each.
